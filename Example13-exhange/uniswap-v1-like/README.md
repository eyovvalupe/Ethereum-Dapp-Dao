## uniswap-v1-like

仿 uniswap-v1 项目(合约部分)，原教程链接见最下方，强烈建议跟着原教程的步骤撸一遍，风味最佳。

截至 2021 年 6 月，Uniswap 已推出三个版本（`V1`, `V2`, `V3`）。

`V1` 只允许在以太币和代币之间进行交换。如果需要进行非 eth 之间的交换，则需要通过 eth 中转。
我们将尝试了解 `V1` 的经济机制，找出、分解、学习和构建它们的核心机制。

### 经济模型

#### Market makers (做市商)

做市商是向市场提供流动性（交易资产）的实体。流动性使交易成为可能：如果您想出售某物但没有人购买，则不会进行交易。一些交易对具有高流动性（例如 BTC-USDT），但有些交易对的流动性很低或根本没有（例如一些骗局或山寨币）。

DEX(去中心化交易所)必须有足够（或大量）流动性才能运作并替代中心化交易所。通常需要 DEX 团队投入大量资金来提供足够的流动性(考虑到众多的代币种类，这是一笔庞大的投入)，并且这样会使得 DEX 团队成为唯一的做市商，拥有巨大的权力，有违 DEX 去中心化的初衷。

更好的解决方案是允许任何人成为做市商

#### Automated market maker (AMM 自动做市商)

AMM(自动化做市商)是一个通用术语，包含不同的去中心化做市商算法，Uniswap 是其中最受欢迎的算法之一。

#### Constant product market maker (恒定的产品做市商)

```math
x∗y=k
```

这是 UniswapV1 的核心公式，`x` 和 `y` 分别代表两个 token(在 V1 中其中一个必定是 eth)的储备量，两者的乘积需要保持一个恒定的值，即 `k`。当您用以太币交易代币时，您将以太币存入合约并获得一定数量的代币作为回报。Uniswap 确保在每次交易后至至 保持不变（然而并非完全不变，会存在无常损失）。

#### 定价功能

##### 简单的设想，利用汇率构建价格

```math
Px = y / x,
Py = x / y
```

`x` 和 `y` 代表两个代币的储备量，`Px` 和 `Py` 代表价格。
这是一个简单且符合直觉的设想，然而存在很大的问题。

假设我们用 2000 个 token 和 1000 个 eth 创建了一个流动性池，此时 1 个 token 等于 0.5 个 eth，1 个 eth 等于 2 个 token。

```math
Ptoken = 1000 / 2000 = 0.5 \\
Peth = 2000 / 1000 = 2
```

一切看起来是正确的，但是如果我们利用该池子做交易，将 2000 个 token 交换成 eth 会发生什么？
我们将获得 1000 个 eth，这可是池子里所有的 eth 储备量！**池子被抽干了！**

我们再来看看定价公式，上述定价公式实际上组成了一个和为恒定值的函数。

```math
Msum  = Mx + My = Px * x + Py * y
```

`Msum` 代表两个代币的市值总和，`Mx` 和 `My` 代表两个代币的市值，市值等于 `价格 * 储备量`。

```math
Msum  = (y / x) * x + (x / y) * y = y + x = x + y
```

我们把之前的价格公式带入其中，就会发现总市值实际上就是两者的储备量之和 `x + y`。
即 `x + y = k`, `k` 为常数，其函数图形如下：

![x + y = k](./images/uniswap-v1-like-01.png)

x轴和y轴分别代表了两个代币的储备量，函数穿过x轴和y轴，根据图形可以很直观的看出这个公式允许`x`和`y`其中一个为0！
这也就解释了为何我们用2000个token交换成eth，流动性会枯竭的原因。

##### 正确的定价功能

```math
x∗y=k
```

每一笔交易都会概变两个代币的储备量，该公式指出无论储备量如何变化， `k` 都应该保持不变。

$$(x + \Delta x)(y - \Delta y) = xy$$

这里的意思是用 $\Delta x$ 数量的`token x` 交换出  $\Delta y$ 数量的 `token y`。所以计算 $\Delta y$ 的公式为：

$$\Delta y = \frac{y \Delta x} {x + \Delta x} $$

请注意，我们现在得到的 $\Delta y$ 是数量而不是价格。计算数量的方法对应 `Exchange.getAmount()`。

### 参考链接

原教程：https://jeiwan.net/posts/programming-defi-uniswap-1/
源代码仓库：https://github.com/Jeiwan/zuniswap/tree/part_1/
